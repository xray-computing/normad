/*
 normad v1.4.0
 Normalisation d'Adresse Ã  partir des Open Data Gouvernementales

 ISC License
 by X-ray Computing
*/
var Normad={normalized:!1,error:null};
document.addEventListener("DOMContentLoaded",function(){if("undefined"!==typeof normaFields){var x=Array.isArray(normaFields)?normaFields:Array(normaFields);for(field of x){let v=document.getElementById(field.address),p=document.getElementById(field.postcode),n=document.getElementById(field.city),q=field.partial;p.addEventListener("change",m=>{m=q?"q="+p.value+"&type=municipality":"q="+encodeURIComponent(v.value)+"&postcode="+p.value;var f=new XMLHttpRequest;f.onload=function(){const r=(a,b="change")=>
a&&a.dispatchEvent(new Event(b,{bubbles:!0}));if(200<=f.status&&300>f.status){var g=JSON.parse(f.response);if(!g.hasOwnProperty("features"))return console.log('Normad: Bad Response ("features" is missing)'),!1;for(var t=!1,h=document.querySelectorAll("script"),a=0;a<h.length;a++)if(0<h[a].src.indexOf("bootstrap")){var u=window.bootstrap?window.bootstrap.Tooltip.VERSION:$.fn.tooltip.Constructor.VERSION;t=!0;break}var e=[];h=[];for(a=0;a<g.features.length;a++){var b=g.features[a];0>h.indexOf(b.properties.id)&&
(e.push({id:b.properties.id,address:b.properties.name,postcode:b.properties.postcode,city:b.properties.city}),h.push(b.properties.id))}Normad.normalized=!1;Normad.error=null;Normad.cancel=!1;if(1<e.length){var k=document.getElementById("normadModal");if("undefined"==typeof k||null==k){a=document.createElement("div");a.className="modal";a.setAttribute("tabindex",-1);a.setAttribute("role","dialog");a.setAttribute("id","normadModal");g=document.createElement("div");g.className="modal-dialog";g.setAttribute("role",
"document");h=document.createElement("div");h.className="modal-content";b=document.createElement("div");b.className="modal-header";var c=document.createElement("h5");c.className="modal-title";var d=document.createElement("button");d.className="close";d.setAttribute("type","button");d.setAttribute("data-dismiss","modal");d.setAttribute("aria-label","Fermer");var l=document.createElement("span");l.setAttribute("aria-hidden","true");l.innerHTML="&times;";d.appendChild(l);b.appendChild(c);b.appendChild(d);
c=document.createElement("div");c.className="modal-body";let e=document.createElement("div");e.className="modal-footer";d=document.createElement("button");d.className="btn btn-primary";d.setAttribute("type","button");d.innerHTML="Valider mon choix";l=document.createElement("button");l.className="btn btn-secondary";l.setAttribute("type","button");l.innerHTML="Annuler";l.setAttribute("data-dismiss","modal");let f=[d,l];"undefined"!==typeof normaButtons&&(normaButtons.hasOwnProperty("cancel")&&(normaButtons.cancel.hasOwnProperty("label")&&
(l.innerHTML=normaButtons.cancel.label),normaButtons.cancel.hasOwnProperty("order")&&(f[parseInt(normaButtons.cancel.order)]=l)),normaButtons.hasOwnProperty("submit")&&(normaButtons.submit.hasOwnProperty("order")&&(d.order=normaButtons.submit.order),normaButtons.cancel.hasOwnProperty("order")&&(f[parseInt(normaButtons.submit.order)]=d)));f.forEach(a=>e.appendChild(a));h.appendChild(b);h.appendChild(c);h.appendChild(e);g.appendChild(h);a.appendChild(g);document.body.appendChild(a);k=document.getElementById("normadModal");
g=c}else g=k.querySelector(".modal-body");for(;g.firstChild&&g.removeChild(g.firstChild););k.querySelector(".modal-title").innerHTML="Choisissez une adresse valide";for(a=0;a<e.length;a++){h=e[a].postcode+" - "+e[a].city;q||(h=e[a].address+", "+h);b=document.createElement("div");b.className="input-group mb-1 m-b-1";c=document.createElement("input");c.setAttribute("type","radio");c.setAttribute("id","normAddr-"+a);c.setAttribute("name","normadChoice");c.dataset.id=a;if(t){if(0>u.indexOf("5.")){var m=
document.createElement("div");m.className="input-group-prepend input-group-addon"}d=document.createElement("div");d.className="input-group-text";d.appendChild(c);0>u.indexOf("5.")?(m.appendChild(d),b.appendChild(m)):b.appendChild(d)}else b.appendChild(c);c=document.createElement("label");c.className="form-control";c.setAttribute("for","normAddr-"+a);c.innerHTML=h;b.appendChild(c);g.appendChild(b)}if(t)if(0>u.indexOf("5."))jQuery("#normadModal").modal("show");else{var w=new window.bootstrap.Modal(k);
w.show()}else k.style.display="block",k.querySelector(".btn-secondary").addEventListener("click",a=>{k.style.display="none"}),k.querySelector(".close").addEventListener("click",a=>{k.style.display="none"});k.querySelector(".btn-primary").addEventListener("click",a=>{a=document.querySelectorAll('input[name="normadChoice"]:checked');1==a.length&&(q||(v.value=e[a[0].dataset.id].address),p.value=e[a[0].dataset.id].postcode,n.value=e[a[0].dataset.id].city,Normad.normalized=!0,r(n));t?0>u.indexOf("5.")?
jQuery("#normadModal").modal("hide"):w.hide():k.style.display="none"});k.querySelector(".btn-secondary").addEventListener("click",a=>{Normad.normalized=!1;Normad.cancel=!0;r(n)})}else 1==e.length?(q||(v.value=e[0].address),p.value=e[0].postcode,n.value=e[0].city,Normad.normalized=!0):(console.log("Normad: No Address Found"),Normad.error="No address was found"),r(n)}else console.log("Normad: Request Failed"),Normad.error=g.description,r(n)};f.onerror=function(){console.log("Normad: Query Failed")};
if("withCredentials"in f)f.open("GET","https://api-adresse.data.gouv.fr/search/?"+m,!0);else if("undefined"!=typeof XDomainRequest)f.open("GET","https://api-adresse.data.gouv.fr/search/?"+m);else throw f=null,Error("CORS not supported");null!==f&&f.send()})}}else console.log("'normaFields' var. not defined.")});